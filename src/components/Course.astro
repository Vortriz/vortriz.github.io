---

import Icon from "@/components/Icon.astro";
import Link from "@/components/Link.astro";

interface Material {
    text: string;
    href: string;
    is_large_file?: boolean;
}

interface Props {
    title: string;
    session?: string;
    instructor?: string;
    materials?: Material[];
}

const { title, session, instructor, materials } = Astro.props;
---

<li class="course">
    <strong class="course-title">{title}</strong><br />
    {
        session && (
            <span>
                <strong>Session:</strong> {session}
                <br />
            </span>
        )
    }
    {
        instructor && (
            <span>
                <strong>Instructor:</strong> {instructor}
                <br />
            </span>
        )
    }

    {
        materials && materials.length > 0 && (
            <div class="material-container">
                <strong>Material:</strong>
                <ul class="material-list">
                    {materials.map((material) => (
                        <li>
                            <Link href={material.href}>{material.text}</Link>
                            {material.is_large_file && (
                                <span
                                    class="warning-icon"
                                    data-tooltip="Large file! May take a while to load."
                                >
                                    <Icon name="warning" />
                                </span>
                            )}
                        </li>
                    ))}
                </ul>
            </div>
        )
    }
</li>

<style>
    .course-title {
        font-size: 1.2em;
    }
    .material-container {
        display: flex;
        flex-direction: row;
        align-items: baseline;
    }
    .material-list {
        list-style-type: none;
        padding-left: 0.25rem;
        margin: 0;
    }
    .material-list li {
        padding-left: 0.5em;
        display: flex;
        align-items: center;
    }
    .warning-icon {
        display: inline-block;
        width: 1.2em;
        height: 1.2em;
        vertical-align: text-bottom;
        margin-left: 8px;
        color: var(--warn-color);
        cursor: pointer;
    }
</style>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        let tooltipPortal = document.getElementById("tooltip-portal");

        if (!tooltipPortal) {
            tooltipPortal = document.createElement("div");
            tooltipPortal.id = "tooltip-portal";

            const style = document.createElement("style");
            style.textContent = `
                #tooltip-portal {
                    position: fixed;
                    width: 140px;
                    background-color: var(--tooltip-bg-color);
                    color: var(--tooltip-text-color);
                    font-size: 0.7em;
                    text-align: center;
                    border-radius: 6px;
                    padding: 8px;
                    z-index: 1000;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
                    border: 1px solid var(--border-color);
                    line-height: 1.2em;
                    pointer-events: none;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.3s, visibility 0.3s;
                }
                #tooltip-portal.visible {
                    opacity: 0.95;
                    visibility: visible;
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(tooltipPortal);
        }

        let activeIcon = null;

        const showTooltip = (icon) => {
            activeIcon = icon;
            tooltipPortal.textContent = icon.dataset.tooltip;
            const rect = icon.getBoundingClientRect();

            let top = rect.top - tooltipPortal.offsetHeight - 5;
            let left = rect.left + rect.width / 2 - tooltipPortal.offsetWidth / 2;

            if (top < 0) {
                top = rect.bottom + 5;
            }
            if (left < 0) {
                left = 5;
            }
            if (left + tooltipPortal.offsetWidth > window.innerWidth) {
                left = window.innerWidth - tooltipPortal.offsetWidth - 5;
            }

            tooltipPortal.style.top = `${top}px`;
            tooltipPortal.style.left = `${left}px`;
            tooltipPortal.classList.add("visible");
        };

        const hideTooltip = () => {
            activeIcon = null;
            tooltipPortal.classList.remove("visible");
        };

        document.querySelectorAll(".warning-icon").forEach((icon) => {
            icon.addEventListener("mouseenter", () => showTooltip(icon));
            icon.addEventListener("mouseleave", hideTooltip);
            icon.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (activeIcon === icon) {
                    hideTooltip();
                } else {
                    showTooltip(icon);
                }
            });
        });

        document.addEventListener("click", () => {
            if (activeIcon) hideTooltip();
        });

        window.addEventListener(
            "scroll",
            () => {
                if (activeIcon) hideTooltip();
            },
            true,
        );
    });
</script>
